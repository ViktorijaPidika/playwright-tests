import { test, expect } from '@playwright/test'
import { UAPRegistryPage } from '../../../pages/uapRegistry.page'
import { fillNewObservationForm } from '../../../utils/uapRegistry.helper';

test.describe('Vulnerability test with basic XSS input in Image URL field', () => {

    let uapRegistryPage: UAPRegistryPage;
    const testData = {
        location: 'Riga, Latvia',
        date: '2025-04-06',
        image: '<script>alert(\'XSS\')</script>',
        description: 'There were strange noises and bright lights outside the office, and the office\'s only developer has gone missing.',
    };

    test.beforeEach(async ({ page }) => {
        //authentication is not present on the page. Once issue resolved:
        //add additional log in steps here

        uapRegistryPage = new UAPRegistryPage(page);
        await uapRegistryPage.openUapRegistryPage();
        await expect(uapRegistryPage.newObservationDropDown).toBeVisible();
    });

    test('Verify input safely encoded and no scripts run with reflected XSS in image URL', async () => {
        await test.step('Add new observation', async () => {
            await uapRegistryPage.newObservationDropDown.click();
            await expect(uapRegistryPage.newObservationForm).toBeVisible();

            await fillNewObservationForm(uapRegistryPage, testData);
            await uapRegistryPage.addButton.click();
        });

        await test.step('Verify XSS input is not displayed', async () => {
            await expect(uapRegistryPage.observationArticleTitle.last())
                .not.toHaveText(`${testData.location} (${testData.date})`);
        });
    });
})